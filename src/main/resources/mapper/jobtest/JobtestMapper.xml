<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.piveguyz.empickbackend.employment.jobtests.jobtest.query.mapper.JobtestMapper">

<!--    전체 조회-->
    <resultMap id="JobTestQuestionMap"
               type="com.piveguyz.empickbackend.employment.jobtests.jobtest.query.dto.JobtestQuestionQueryDTO">
        <id property="id" column="job_test_question_id"/>
        <result property="score" column="score"/>
        <result property="optionNumber" column="option_number"/>
        <result property="questionId" column="question_id"/>
    </resultMap>

    <resultMap id="JobTestEvalCriteriaMap"
               type="com.piveguyz.empickbackend.employment.jobtests.jobtest.query.dto.JobtestEvaluationCriteriaQueryDTO">
        <id property="id" column="criteria_id"/>
        <result property="content" column="criteria_content"/>
        <result property="detailContent" column="criteria_detail_content"/>
        <result property="scoreWeight" column="score_weight"/>
    </resultMap>

    <resultMap id="JobTestMap" type="com.piveguyz.empickbackend.employment.jobtests.jobtest.query.dto.JobtestQueryDTO">
        <id property="id" column="job_test_id"/>
        <result property="title" column="job_test_title"/>
        <result property="difficulty" column="difficulty"/>
        <result property="testTime" column="test_time"/>
        <result property="startedAt" column="started_at"/>
        <result property="endedAt" column="ended_at"/>
        <result property="creatorName" column="creator_name"/>
        <result property="updatedName" column="updated_name"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>

        <collection property="questions"
                    ofType="com.piveguyz.empickbackend.employment.jobtests.jobtest.query.dto.JobtestQuestionQueryDTO"
                    resultMap="JobTestQuestionMap"/>
        <collection property="evaluationCriteria"
                    ofType="com.piveguyz.empickbackend.employment.jobtests.jobtest.query.dto.JobtestEvaluationCriteriaQueryDTO"
                    resultMap="JobTestEvalCriteriaMap"/>
    </resultMap>


    <!--    상세조회-->
    <resultMap id="ApplicationJobtestMap"
               type="com.piveguyz.empickbackend.employment.jobtests.jobtest.query.dto.ApplicationJobtestQueryDTO">
        <id property="applicationId" column="application_id"/>
        <result property="applicantId" column="applicant_id"/>
        <result property="applicantName" column="applicant_name"/>
    </resultMap>

    <resultMap id="JobTestApplicationsMap"
               type="com.piveguyz.empickbackend.employment.jobtests.jobtest.query.dto.JobtestApplicationsDTO">
        <id property="id" column="job_test_id"/>
        <result property="title" column="job_test_title"/>
        <result property="difficulty" column="difficulty"/>
        <result property="testTime" column="test_time"/>
        <result property="startedAt" column="started_at"/>
        <result property="endedAt" column="ended_at"/>
        <result property="creatorName" column="creator_name"/>
        <result property="updatedName" column="updated_name"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>

        <collection property="questions" resultMap="JobTestQuestionMap"/>
        <collection property="evaluationCriteria" resultMap="JobTestEvalCriteriaMap"/>
        <collection property="applications" resultMap="ApplicationJobtestMap"/>
    </resultMap>




    <!--    전체 실무테스트 목록 조회-->
    <select id="findAllJobTests" resultMap="JobTestMap">
        SELECT jt.id    AS job_test_id,
               jt.title AS job_test_title,
               jt.difficulty,
               jt.test_time,
               jt.started_at,
               jt.ended_at,
               cm.name  AS creator_name,
               um.name  AS updated_name,
               jt.created_at,
               jt.updated_at
        FROM job_test jt
                 JOIN member cm ON jt.created_member_id = cm.id
                 LEFT JOIN member um ON jt.updated_member_id = um.id
        ORDER BY jt.created_at DESC
    </select>

    <!--    특정 실무테스트 조회-->
    <select id="findJobTestWithApplications" resultMap="JobTestApplicationsMap" parameterType="int">
        SELECT jt.id               AS job_test_id,
               jt.title            AS job_test_title,
               jt.difficulty,
               jt.test_time,
               jt.started_at,
               jt.ended_at,
               cm.name             AS creator_name,
               um.name             AS updated_name,
               jt.created_at,
               jt.updated_at,

               jtq.id              AS job_test_question_id,
               jtq.score,
               jtq.option_number,
               jtq.question_id,

               jtec.id             AS criteria_id,
               jtec.content        AS criteria_content,
               jtec.detail_content AS criteria_detail_content,
               jtec.score_weight,

               a.id                AS application_id,
               a.applicant_id,
               ap.name             AS applicant_name

        FROM job_test jt
                 JOIN member cm ON jt.created_member_id = cm.id
                 LEFT JOIN member um ON jt.updated_member_id = um.id
                 LEFT JOIN job_test_question jtq ON jtq.job_test_id = jt.id
                 LEFT JOIN job_test_evaluation_criteria jtec ON jtec.job_test_id = jt.id
                 LEFT JOIN application_job_test ajt ON ajt.job_test_id = jt.id
                 LEFT JOIN application a ON ajt.application_id = a.id
                 LEFT JOIN applicant ap ON a.applicant_id = ap.id
        WHERE jt.id = #{id}
    </select>

</mapper>
